<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogador de Livros - v2.2</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-green-500: rgba(34, 197, 94, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-teal-300-rgb: 50, 184, 198;
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-border: rgba(var(--color-gray-300-rgb), 0.3);
                --color-btn-primary-text: var(--color-slate-900);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 16px;
        }

        .version-badge {
            display: inline-block;
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .feature-badge {
            display: inline-block;
            background: var(--color-green-500);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .backup-reminder {
            background: var(--color-orange-400);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .backup-reminder.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--color-surface);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card {
            background: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-section {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            padding: 32px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 24px;
            color: white;
        }

        .scanner-section h3 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .scanner-section p {
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .btn-scan {
            background: white;
            color: var(--color-primary);
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .btn-scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            padding: 20px;
        }

        .scanner-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-container {
            max-width: 640px;
            width: 100%;
            background: var(--color-surface);
            border-radius: 12px;
            overflow: hidden;
        }

        .scanner-header {
            background: var(--color-primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-header h3 {
            font-size: 20px;
        }

        .close-scanner {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scanner-viewport {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        #scanner-viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid var(--color-green-500);
            border-radius: 12px;
            pointer-events: none;
        }

        .scanner-status {
            background: var(--color-background);
            padding: 20px;
            text-align: center;
            color: var(--color-text);
        }

        .scanner-loading {
            display: none;
            padding: 20px;
            text-align: center;
        }

        .spinner {
            border: 3px solid var(--color-secondary);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 15px;
            background: var(--color-background);
            color: var(--color-text);
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        input:disabled, select:disabled, textarea:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(var(--color-brown-600-rgb), 0.2);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-bar input {
            flex: 1;
            min-width: 200px;
        }

        .filter-bar select {
            min-width: 150px;
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .book-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .book-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .book-cover {
            width: 60px;
            height: 90px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--color-secondary);
            flex-shrink: 0;
        }

        .book-cover-placeholder {
            width: 60px;
            height: 90px;
            border-radius: 6px;
            background: var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .book-info {
            flex: 1;
            min-width: 0;
        }

        .book-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .book-author {
            color: var(--color-text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .book-meta {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .book-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .badge-status {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            flex: 1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-text-secondary);
            line-height: 1;
            padding: 0;
            margin-left: 16px;
        }

        .detail-grid {
            display: grid;
            gap: 16px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .detail-value {
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .storage-info {
            background: var(--color-secondary);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--color-text-secondary);
            text-align: center;
            margin-top: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--color-green-500);
            border: 1px solid var(--color-green-500);
        }

        .alert-warning {
            background: rgba(230, 129, 97, 0.1);
            color: var(--color-orange-400);
            border: 1px solid var(--color-orange-400);
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .books-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 24px;
            }

            .scanner-section {
                padding: 24px;
            }

            .btn-scan {
                font-size: 16px;
                padding: 14px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Catalogador de Livros <span class="version-badge">v2.2</span><span class="feature-badge">üÜï Scanner ISBN</span></h1>
            <p class="subtitle">Escanear c√≥digo de barras com a c√¢mera!</p>
        </header>

        <div id="backupReminder" class="backup-reminder">
            ‚ö†Ô∏è Lembrete: Fa√ßa backup do seu acervo regularmente! <button class="btn btn-small" onclick="exportJSON()" style="margin-left: 12px;">Fazer Backup Agora</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalBooks">0</div>
                <div class="stat-label">Total de Livros</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="readBooks">0</div>
                <div class="stat-label">Lidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="readingBooks">0</div>
                <div class="stat-label">Lendo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="toReadBooks">0</div>
                <div class="stat-label">Quero Ler</div>
            </div>
        </div>

        <!-- SE√á√ÉO: Scanner de ISBN -->
        <div class="scanner-section">
            <h3>üì∑ Adicionar Livro Rapidamente</h3>
            <p>Escaneie o c√≥digo de barras (ISBN) do livro com sua c√¢mera e preenchemos os dados automaticamente!</p>
            <button class="btn-scan" onclick="openScanner()">
                <span style="font-size: 24px;">üì∑</span>
                <span>Escanear ISBN com C√¢mera</span>
            </button>
        </div>

        <div class="card">
            <div class="card-title">
                <span>‚ûï Adicionar Livro Manualmente</span>
            </div>
            
            <div id="apiAlert" style="display: none;"></div>
            
            <form id="bookForm" onsubmit="addBook(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">T√≠tulo *</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="author">Autor *</label>
                        <input type="text" id="author" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="isbn">ISBN</label>
                        <input type="text" id="isbn">
                    </div>
                    <div class="form-group">
                        <label for="publisher">Editora</label>
                        <input type="text" id="publisher">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Ano</label>
                        <input type="number" id="year" min="1000" max="2099">
                    </div>
                    <div class="form-group">
                        <label for="pages">P√°ginas</label>
                        <input type="number" id="pages" min="1">
                    </div>
                    <div class="form-group">
                        <label for="category">Categoria *</label>
                        <select id="category" required>
                            <option value="">Selecione...</option>
                            <option value="Fic√ß√£o">Fic√ß√£o</option>
                            <option value="N√£o-fic√ß√£o">N√£o-fic√ß√£o</option>
                            <option value="Romance">Romance</option>
                            <option value="Mist√©rio">Mist√©rio</option>
                            <option value="Fantasia">Fantasia</option>
                            <option value="Fic√ß√£o Cient√≠fica">Fic√ß√£o Cient√≠fica</option>
                            <option value="Biografia">Biografia</option>
                            <option value="Hist√≥ria">Hist√≥ria</option>
                            <option value="Autoajuda">Autoajuda</option>
                            <option value="T√©cnico">T√©cnico</option>
                            <option value="Infantil">Infantil</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" required>
                            <option value="">Selecione...</option>
                            <option value="Quero Ler">Quero Ler</option>
                            <option value="Lendo">Lendo</option>
                            <option value="Lido">Lido</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rating">Avalia√ß√£o</label>
                        <select id="rating">
                            <option value="">Sem avalia√ß√£o</option>
                            <option value="1">‚≠ê 1 estrela</option>
                            <option value="2">‚≠ê‚≠ê 2 estrelas</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê 3 estrelas</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 estrelas</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 estrelas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">Localiza√ß√£o</label>
                        <input type="text" id="location" placeholder="Ex: Estante 1, Prateleira 2">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group form-group-full">
                        <label for="cover">URL da Capa (opcional)</label>
                        <input type="url" id="cover" placeholder="https://exemplo.com/capa.jpg">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group form-group-full">
                        <label for="notes">Sinopse / Notas</label>
                        <textarea id="notes" placeholder="Adicione uma sinopse ou notas sobre o livro..."></textarea>
                    </div>
                </div>

                <button type="submit" class="btn">Adicionar ao Acervo</button>
            </form>
        </div>

        <div class="card">
            <div class="card-title">
                <span>üìñ Meu Acervo</span>
                <div class="btn-group">
                    <button class="btn btn-secondary btn-small" onclick="exportJSON()">üíæ Backup JSON</button>
                    <button class="btn btn-secondary btn-small" onclick="exportCSV()">üìä Exportar CSV</button>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">üìÇ Importar</button>
                    <input type="file" id="importFile" accept=".json,.csv" style="display: none" onchange="importData(event)">
                </div>
            </div>

            <div class="filter-bar">
                <input type="text" id="searchInput" placeholder="üîç Buscar por t√≠tulo, autor ou ISBN...">
                <select id="filterCategory">
                    <option value="">Todas as Categorias</option>
                    <option value="Fic√ß√£o">Fic√ß√£o</option>
                    <option value="N√£o-fic√ß√£o">N√£o-fic√ß√£o</option>
                    <option value="Romance">Romance</option>
                    <option value="Mist√©rio">Mist√©rio</option>
                    <option value="Fantasia">Fantasia</option>
                    <option value="Fic√ß√£o Cient√≠fica">Fic√ß√£o Cient√≠fica</option>
                    <option value="Biografia">Biografia</option>
                    <option value="Hist√≥ria">Hist√≥ria</option>
                    <option value="Autoajuda">Autoajuda</option>
                    <option value="T√©cnico">T√©cnico</option>
                    <option value="Infantil">Infantil</option>
                    <option value="Outro">Outro</option>
                </select>
                <select id="filterStatus">
                    <option value="">Todos os Status</option>
                    <option value="Quero Ler">Quero Ler</option>
                    <option value="Lendo">Lendo</option>
                    <option value="Lido">Lido</option>
                </select>
            </div>

            <div id="booksContainer"></div>

            <div class="storage-info">
                üíæ Seus livros s√£o salvos automaticamente no navegador. 
                Fa√ßa backups regulares usando "Backup JSON" para n√£o perder seus dados!
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Livro -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Modal do Scanner -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container">
            <div class="scanner-header">
                <h3>üì∑ Scanner de ISBN</h3>
                <button class="close-scanner" onclick="closeScanner()">√ó</button>
            </div>
            <div id="scanner-viewport">
                <div class="scanner-overlay"></div>
            </div>
            <div class="scanner-status">
                <p id="scanner-message">Aponte a c√¢mera para o c√≥digo de barras do livro</p>
            </div>
            <div class="scanner-loading" id="scanner-loading">
                <div class="spinner"></div>
                <p>Buscando dados do livro...</p>
            </div>
        </div>
    </div>

    <!-- QuaggaJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.7.3/dist/quagga.min.js"></script>

    <script>
        // ============================================
        // SISTEMA DE PERSIST√äNCIA - localStorage
        // ============================================
        
        const STORAGE_KEY = 'catalogador-livros-acervo';
        const BACKUP_REMINDER_KEY = 'catalogador-livros-last-backup';
        
        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                return [];
            }
        }
        
        function saveToStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                console.log('‚úÖ Dados salvos automaticamente!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
                alert('Erro ao salvar dados. Seu navegador pode estar com pouco espa√ßo.');
                return false;
            }
        }
        
        function checkBackupReminder() {
            const lastBackup = localStorage.getItem(BACKUP_REMINDER_KEY);
            const now = Date.now();
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;
            
            if (!lastBackup || (now - parseInt(lastBackup)) > thirtyDays) {
                document.getElementById('backupReminder').classList.add('show');
            }
        }
        
        function markBackupDone() {
            localStorage.setItem(BACKUP_REMINDER_KEY, Date.now().toString());
            document.getElementById('backupReminder').classList.remove('show');
        }
        
        // ============================================
        // DADOS E ESTADO
        // ============================================
        
        let books = loadFromStorage();
        let currentBookId = null;

        // ============================================
        // SCANNER DE ISBN
        // ============================================
        
        let scannerActive = false;
        let lastDetectedCode = null;
        let lastDetectedTime = 0;

        function openScanner() {
            document.getElementById('scannerModal').classList.add('active');
            document.getElementById('scanner-message').textContent = 'Aponte a c√¢mera para o c√≥digo de barras do livro';
            startScanner();
        }

        function closeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            document.getElementById('scannerModal').classList.remove('active');
        }

        function startScanner() {
            // reset estado de detec√ß√£o
            lastDetectedCode = null;
            lastDetectedTime = 0;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-viewport'),
                    constraints: {
                        facingMode: { ideal: "environment" }, // c√¢mera traseira quando poss√≠vel
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        aspectRatio: { ideal: 1.777 } // 16:9
                    },
                },
                decoder: {
                    readers: [
                        "ean_reader",      // EAN-13 (ISBN-13)
                        "ean_8_reader",    // EAN-8
                        "code_128_reader", // Code 128
                        "code_39_reader",  // Code 39
                        "upc_reader",      // UPC
                        "upc_e_reader"     // UPC-E
                    ]
                },
                locate: true,
                frequency: 10,
            }, function(err) {
                if (err) {
                    console.error('Erro ao iniciar scanner:', err);
                    alert('‚ö†Ô∏è N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.');
                    closeScanner();
                    return;
                }
                console.log("Scanner iniciado com sucesso");
                Quagga.start();
                scannerActive = true;
            });

            Quagga.onDetected(function(result) {
                if (!result || !result.codeResult || !result.codeResult.code) {
                    return;
                }

                const code = result.codeResult.code;
                const now = Date.now();
                console.log("C√≥digo detectado:", code);
                
                // Evitar leituras duplicadas do mesmo c√≥digo em sequ√™ncia
                if (code === lastDetectedCode && now - lastDetectedTime < 1500) {
                    return;
                }

                lastDetectedCode = code;
                lastDetectedTime = now;
                
                // Validar se √© um ISBN v√°lido (10 ou 13 d√≠gitos)
                if (code.length === 10 || code.length === 13) {
                    document.getElementById('scanner-message').textContent = `‚úÖ ISBN detectado: ${code}`;
                    
                    // Parar scanner
                    Quagga.stop();
                    scannerActive = false;
                    
                    // Buscar dados do livro
                    fetchBookData(code);
                } else {
                    document.getElementById('scanner-message').textContent = 'C√≥digo inv√°lido. Tente novamente.';
                }
            });
        }

        // ============================================
        // BUSCAR DADOS DO LIVRO (Google Books API)
        // ============================================
        
        async function fetchBookData(isbn) {
            // Mostrar loading
            document.getElementById('scanner-loading').style.display = 'block';
            document.getElementById('scanner-message').textContent = 'Buscando dados do livro...';
            
            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const book = data.items[0].volumeInfo;

                    const cover =
                        book.imageLinks
                            ? (
                                book.imageLinks.large ||
                                book.imageLinks.medium ||
                                book.imageLinks.small ||
                                book.imageLinks.thumbnail ||
                                book.imageLinks.smallThumbnail ||
                                ''
                              )
                            : '';
                    
                    // Preencher formul√°rio
                    fillFormWithBookData({
                        isbn: isbn,
                        title: book.title || '',
                        author: book.authors ? book.authors.join(', ') : '',
                        publisher: book.publisher || '',
                        year: book.publishedDate ? book.publishedDate.substring(0, 4) : '',
                        pages: book.pageCount || '',
                        cover: cover,
                        notes: book.description || ''
                    });
                    
                    showAlert('success', `‚úÖ Livro encontrado: "${book.title}". Complete os campos e adicione!`);
                    closeScanner();
                    
                    // Scroll para o formul√°rio
                    document.getElementById('bookForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Livro n√£o encontrado na API
                    document.getElementById('isbn').value = isbn;
                    showAlert('warning', `‚ö†Ô∏è ISBN ${isbn} detectado, mas n√£o encontramos dados na biblioteca. Preencha os campos manualmente.`);
                    closeScanner();
                    document.getElementById('bookForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                document.getElementById('isbn').value = isbn;
                showAlert('warning', `‚ö†Ô∏è Erro ao buscar dados. ISBN ${isbn} foi preenchido. Complete os outros campos manualmente.`);
                closeScanner();
                document.getElementById('bookForm').scrollIntoView({ behavior: 'smooth' });
            } finally {
                document.getElementById('scanner-loading').style.display = 'none';
            }
        }

        function fillFormWithBookData(data) {
            document.getElementById('isbn').value = data.isbn || '';
            document.getElementById('title').value = data.title || '';
            document.getElementById('author').value = data.author || '';
            document.getElementById('publisher').value = data.publisher || '';
            document.getElementById('year').value = data.year || '';
            document.getElementById('pages').value = data.pages || '';
            document.getElementById('cover').value = data.cover || '';
            
            // Preencher notas apenas se estiver vazio
            if (!document.getElementById('notes').value) {
                document.getElementById('notes').value = data.notes ? data.notes.substring(0, 500) : '';
            }
        }

        function showAlert(type, message) {
            const alertDiv = document.getElementById('apiAlert');
            alertDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-warning';
            alertDiv.innerHTML = `<span style="font-size: 20px;">${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${message}</span>`;
            alertDiv.style.display = 'flex';
            
            // Auto-hide ap√≥s 8 segundos
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 8000);
        }

        // ============================================
        // ADICIONAR LIVRO
        // ============================================
        
        function addBook(event) {
            event.preventDefault();
            
            const book = {
                id: Date.now(),
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                isbn: document.getElementById('isbn').value,
                publisher: document.getElementById('publisher').value,
                year: document.getElementById('year').value,
                pages: document.getElementById('pages').value,
                category: document.getElementById('category').value,
                status: document.getElementById('status').value,
                rating: document.getElementById('rating').value,
                location: document.getElementById('location').value,
                cover: document.getElementById('cover').value,
                notes: document.getElementById('notes').value,
                addedDate: new Date().toISOString()
            };
            
            books.push(book);
            saveToStorage(books);
            updateDisplay();
            document.getElementById('bookForm').reset();
            document.getElementById('apiAlert').style.display = 'none';
            
            // Scroll suave para o acervo
            document.getElementById('booksContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // ATUALIZAR DISPLAY
        // ============================================
        
        function updateDisplay() {
            updateStats();
            displayBooks();
        }

        function updateStats() {
            document.getElementById('totalBooks').textContent = books.length;
            document.getElementById('readBooks').textContent = books.filter(b => b.status === 'Lido').length;
            document.getElementById('readingBooks').textContent = books.filter(b => b.status === 'Lendo').length;
            document.getElementById('toReadBooks').textContent = books.filter(b => b.status === 'Quero Ler').length;
        }

        function displayBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterCategory = document.getElementById('filterCategory').value;
            const filterStatus = document.getElementById('filterStatus').value;

            let filtered = books.filter(book => {
                const matchSearch = !searchTerm || 
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.isbn && book.isbn.toLowerCase().includes(searchTerm));
                
                const matchCategory = !filterCategory || book.category === filterCategory;
                const matchStatus = !filterStatus || book.status === filterStatus;
                
                return matchSearch && matchCategory && matchStatus;
            });

            const container = document.getElementById('booksContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>Nenhum livro encontrado</h3>
                        <p>Escaneie um ISBN ou adicione livros manualmente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="books-grid">
                    ${filtered.map(book => `
                        <div class="book-card" onclick="showBookDetails(${book.id})">
                            <div class="book-header">
                                ${book.cover 
                                    ? `<img src="${book.cover}" alt="${book.title}" class="book-cover">` 
                                    : `<div class="book-cover-placeholder">üìñ</div>`
                                }
                                <div class="book-info">
                                    <div class="book-title">${book.title}</div>
                                    <div class="book-author">${book.author}</div>
                                    <div class="book-meta">
                                        ${book.year ? `<span>${book.year}</span>` : ''}
                                        ${book.pages ? `<span>${book.pages}p</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span class="badge">${book.category}</span>
                                <span class="badge badge-status">${book.status}</span>
                                ${book.rating ? `<span class="badge">${'‚≠ê'.repeat(parseInt(book.rating))}</span>` : ''}
                            </div>
                            <div class="book-actions">
                                <button class="btn btn-small" style="flex: 1;" onclick="event.stopPropagation(); showBookDetails(${book.id})">Ver Detalhes</button>
                                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); deleteBook(${book.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================
        // DETALHES DO LIVRO
        // ============================================
        
        function showBookDetails(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;

            currentBookId = id;
            document.getElementById('modalTitle').textContent = book.title;
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                ${book.cover ? `
                    <div style="text-align: center; margin-bottom: 24px;">
                        <img src="${book.cover}" alt="${book.title}" style="max-width: 200px; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    </div>
                ` : ''}
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Autor:</span>
                        <span class="detail-value">${book.author}</span>
                    </div>
                    ${book.isbn ? `
                        <div class="detail-item">
                            <span class="detail-label">ISBN:</span>
                            <span class="detail-value">${book.isbn}</span>
                        </div>
                    ` : ''}
                    ${book.publisher ? `
                        <div class="detail-item">
                            <span class="detail-label">Editora:</span>
                            <span class="detail-value">${book.publisher}</span>
                        </div>
                    ` : ''}
                    ${book.year ? `
                        <div class="detail-item">
                            <span class="detail-label">Ano:</span>
                            <span class="detail-value">${book.year}</span>
                        </div>
                    ` : ''}
                    ${book.pages ? `
                        <div class="detail-item">
                            <span class="detail-label">P√°ginas:</span>
                            <span class="detail-value">${book.pages}</span>
                        </div>
                    ` : ''}
                    <div class="detail-item">
                        <span class="detail-label">Categoria:</span>
                        <span class="detail-value">${book.category}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value"><span class="badge badge-status">${book.status}</span></span>
                    </div>
                    ${book.rating ? `
                        <div class="detail-item">
                            <span class="detail-label">Avalia√ß√£o:</span>
                            <span class="detail-value">${'‚≠ê'.repeat(parseInt(book.rating))} (${book.rating}/5)</span>
                        </div>
                    ` : ''}
                    ${book.location ? `
                        <div class="detail-item">
                            <span class="detail-label">Localiza√ß√£o:</span>
                            <span class="detail-value">${book.location}</span>
                        </div>
                    ` : ''}
                    <div class="detail-item">
                        <span class="detail-label">Adicionado em:</span>
                        <span class="detail-value">${new Date(book.addedDate).toLocaleDateString('pt-BR')}</span>
                    </div>
                    ${book.notes ? `
                        <div class="detail-item" style="display: block;">
                            <span class="detail-label" style="display: block; margin-bottom: 8px;">Sinopse / Notas:</span>
                            <span class="detail-value" style="white-space: pre-wrap;">${book.notes}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('bookModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('bookModal').classList.remove('active');
        }

        // ============================================
        // DELETAR LIVRO
        // ============================================
        
        function deleteBook(id) {
            if (confirm('Deseja realmente remover este livro do acervo?')) {
                books = books.filter(b => b.id !== id);
                saveToStorage(books);
                updateDisplay();
            }
        }

        // ============================================
        // EXPORTAR JSON
        // ============================================
        
        function exportJSON() {
            if (books.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° livros para exportar!');
                return;
            }

            const dataStr = JSON.stringify(books, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `acervo-livros-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            markBackupDone();
            alert('‚úÖ Backup JSON criado com sucesso!');
        }

        // ============================================
        // EXPORTAR CSV
        // ============================================
        
        function exportCSV() {
            if (books.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° livros para exportar!');
                return;
            }

            const headers = ['T√≠tulo', 'Autor', 'ISBN', 'Editora', 'Ano', 'P√°ginas', 'Categoria', 'Status', 'Avalia√ß√£o', 'Localiza√ß√£o', 'URL Capa', 'Notas', 'Data Adi√ß√£o'];
            
            const rows = books.map(book => [
                book.title,
                book.author,
                book.isbn || '',
                book.publisher || '',
                book.year || '',
                book.pages || '',
                book.category,
                book.status,
                book.rating || '',
                book.location || '',
                book.cover || '',
                book.notes ? book.notes.replace(/\n/g, ' ') : '',
                new Date(book.addedDate).toLocaleDateString('pt-BR')
            ]);

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `acervo-livros-${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ CSV exportado com sucesso!');
        }

        // ============================================
        // IMPORTAR DADOS
        // ============================================
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    importJSON(content);
                } else if (file.name.endsWith('.csv')) {
                    importCSV(content);
                } else {
                    alert('‚ö†Ô∏è Formato n√£o suportado! Use .json ou .csv');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function importJSON(content) {
            try {
                const imported = JSON.parse(content);
                if (!Array.isArray(imported)) {
                    alert('‚ö†Ô∏è Formato de arquivo inv√°lido!');
                    return;
                }

                const action = confirm(
                    `Importar ${imported.length} livros?\n\n` +
                    `OK = SUBSTITUIR | CANCELAR = MESCLAR`
                );

                if (action) {
                    books = imported;
                } else {
                    const newBooks = imported.map(book => ({
                        ...book,
                        id: Date.now() + Math.random()
                    }));
                    books = [...books, ...newBooks];
                }

                saveToStorage(books);
                updateDisplay();
                alert('‚úÖ Acervo importado com sucesso!');
            } catch (error) {
                alert('‚ùå Erro ao importar arquivo: ' + error.message);
            }
        }

        function importCSV(content) {
            try {
                const lines = content.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    alert('‚ö†Ô∏è CSV vazio ou inv√°lido!');
                    return;
                }

                const dataLines = lines.slice(1);
                
                const imported = dataLines.map(line => {
                    const values = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g)
                        .map(v => v.replace(/^"|"$/g, '').trim());

                    return {
                        id: Date.now() + Math.random(),
                        title: values[0] || '',
                        author: values[1] || '',
                        isbn: values[2] || '',
                        publisher: values[3] || '',
                        year: values[4] || '',
                        pages: values[5] || '',
                        category: values[6] || 'Outro',
                        status: values[7] || 'Quero Ler',
                        rating: values[8] || '',
                        location: values[9] || '',
                        cover: values[10] || '',
                        notes: values[11] || '',
                        addedDate: new Date().toISOString()
                    };
                });

                const action = confirm(
                    `Importar ${imported.length} livros do CSV?\n\n` +
                    `OK = SUBSTITUIR | CANCELAR = MESCLAR`
                );

                if (action) {
                    books = imported;
                } else {
                    books = [...books, ...imported];
                }

                saveToStorage(books);
                updateDisplay();
                alert('‚úÖ CSV importado com sucesso!');
            } catch (error) {
                alert('‚ùå Erro ao importar CSV: ' + error.message);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        document.getElementById('searchInput').addEventListener('input', displayBooks);
        document.getElementById('filterCategory').addEventListener('change', displayBooks);
        document.getElementById('filterStatus').addEventListener('change', displayBooks);

        // Fechar modal ao clicar fora
        document.getElementById('bookModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Fechar scanner ao clicar fora
        document.getElementById('scannerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeScanner();
            }
        });

        // Fechar com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeScanner();
            }
        });

        // ============================================
        // INICIALIZAR
        // ============================================
        
        updateDisplay();
        checkBackupReminder();
        
        console.log('üìö Catalogador de Livros v2.2 inicializado!');
        console.log(`üíæ ${books.length} livros carregados do localStorage`);
        console.log('üì∑ Scanner de ISBN ativado!');
    </script>
</body>
</html>
